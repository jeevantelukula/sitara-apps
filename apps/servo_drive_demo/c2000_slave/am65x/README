C2000 Slave Code for AM65x Demo
===============================

Existing Demo Documentation
------------------
This Sitara multi-axis master demo is based on a C2000 TI Design documented here:
[Distributed multi-axis servo drive over fast serial interface (FSI) reference design](http://www.ti.com/tool/TIDM-02006 "TIDM-02006")

The C2000 code for the demo is provided here (v3.00.00.00 is used in our demo):
[MotorControl software development kit (SDK) for C2000 MCUs](http://www.ti.com/tool/download/C2000WARE-MOTORCONTROL-SDK "MotorControl SDK")

C2000 slave binary provided
--------------------
Modifications are required for the slave side of the demo to interoperate with
the AM65x PRU FSI implementation. For this reason a pre-built binary for the
C2000 slave has been provided in this folder:
multi_axis_slave_node1_f28004x_cpu.out

After following the TI Design guide for the C2000 slave softwae, the modifications
to the v3.00.00.00 version of the C2000 MotorControl SDK are as follows:
* Change the FSI speed from 50MHz to 12.5MHz  
        Change the PRESCALER_VAL definition from FSI_PRESCALE_50MHz to the number ‘8’
(8 correspods to 200MHz/2/8=12.5)  
        Line 71 in the %MC_SDK%/solutions/common/sensored_foc/include/multi_axis_fsi_shared.h
file
* Comment out the FSI_executeTxFlushSequence from the slave handshake  
        The PRU implementation can’t handle the flush right before the PING0, so
remove it  
        Line 350 in the multi_axis_slave_comms.c file is the flush: comment it out
* Add an RX core reset if the RX timeout occurs  
        For some reason the C2K FSI RX core locks up when it doesn’t like something,
instead of detecting and resetting, they just let it die  
        Add an FSI_resetRxModule and FSI_clearRxModuleReset call into the fsiRxTimeOutCntr == 0
case of FSI_run_TRxData function in multi_axis_slave_comms.c file  
```
    FSI_disableRxInterrupt(obj->fsiRxHandle, FSI_INT1, FSI_RX_EVT_PING_FRAME);

    /* Added by JR */
    FSI_resetRxModule(obj->fsiRxHandle, FSI_RX_MASTER_CORE_RESET);

    DEVICE_DELAY_US(10);

    /* Added by JR */
    FSI_clearRxModuleReset(obj->fsiRxHandle, FSI_RX_MASTER_CORE_RESET);

    Interrupt_clearACKGroup(INTERRUPT_ACK_GROUP7);
```
* Reduce the fsiRxTimeOutCntr to detect a failure faster
   change FSI_RX_TIME_OUT_CNTR from 0x200000 to decimal 100000  
   line 63 in %MC_SDK%/solutions/common/sensored_foc/include/multi_axis_slave_nodes.h file

The three source files that contain these four changes are included in the same
folder as this README file. Copy them on top of the same files in the C2000
slave node project.
