C2000 Slave Code for AM64x Demo
===============================

Existing Demo Documentation
------------------
This Sitara multi-axis master demo is based on a C2000 TI Design documented here:
[Distributed multi-axis servo drive over fast serial interface (FSI) reference design](http://www.ti.com/tool/TIDM-02006 "TIDM-02006")

The C2000 code for the demo is provided here (v3.00.00.00 is used in our demo):
[MotorControl software development kit (SDK) for C2000 MCUs](http://www.ti.com/tool/download/C2000WARE-MOTORCONTROL-SDK "MotorControl SDK")

C2000 slave binary provided
--------------------
Modifications are required for the slave side of the demo to interoperate with
the AM64x implementation. For this reason pre-built RAM and FLASH binaries for the
three C2000 slave nodes have been provided:
multi_axis_slave_node1_f28004x_cpu\F28004x_FLASH\multi_axis_slave_node1_f28004x_cpu.out
multi_axis_slave_node1_f28004x_cpu\F28004x_RAM\multi_axis_slave_node1_f28004x_cpu.out
multi_axis_slave_node2_f28004x_cpu\F28004x_FLASH\multi_axis_slave_node2_f28004x_cpu.out
multi_axis_slave_node2_f28004x_cpu\F28004x_RAM\multi_axis_slave_node2_f28004x_cpu.out
multi_axis_slave_node2_f28004x_cpu\F28004x_FLASH\multi_axis_slave_node3_f28004x_cpu.out
multi_axis_slave_node2_f28004x_cpu\F28004x_RAM\multi_axis_slave_node3_f28004x_cpu.out

After following the TI Design guide for the C2000 slave software, the modifications
to the v3.00.00.00 version of the C2000 MotorControl SDK are as follows:
* Change the FSI speed from 50 MHz to 25 MHz
    change the PRESCALER_VAL definition from FSI_PRESCALE_50MHz to FSI_PRESCALE_25MHz, 
line 71 in file %MC_SDK%/solutions/common/sensored_foc/include/multi_axis_fsi_shared.h
* Change the number of FSI nodes in the daisy chain from 4 to 3
    change the FSI_NODES definition from 4 to 3, 
line 101 in file %MC_SDK%/solutions/common/sensored_foc/include/multi_axis_fsi_shared.h
    change the FSI_NODE_LAST definition from FSI_SLAVE_N4 to FSI_SLAVE_N3, 
line 107 in file %MC_SDK%/solutions/common/sensored_foc/include/multi_axis_fsi_shared.h
    change the FSI_NODE_NEXT definition from FSI_SLAVE_N4 to FSI_SLAVE_N1, 
line 92 in file solutions\tidm_02006_multi_axis_drive\f28004x\include\multi_axis_slave_node3.h
* Ensure FSI transmit is triggered based on an FSI frame reception
    change FSI_TX_TIME_WAIT_CNTR from 10 to decimal 100000
line 60 in file %MC_SDK%/solutions/common/sensored_foc/include/multi_axis_slave_nodes.h
    uncomment fsiTxTimeWaitCntr = 0,
line 773 in file %MC_SDK%/solutions/common/sensored_foc/source/multi_axis_slave_comms.c
* Decrease the fsiRxTimeOutCntr to detect an FSI Rx failure faster
    change FSI_RX_TIME_OUT_CNTR from 0x200000 to decimal 100000, 
line 63 in file %MC_SDK%/solutions/common/sensored_foc/include/multi_axis_slave_nodes.h
* Add an RX core reset if the RX timeout occurs  
        For some reason the C2K FSI RX core locks up when it doesnâ€™t like something,
instead of detecting and resetting, they just let it die  
        Add an FSI_resetRxModule and FSI_clearRxModuleReset call into the fsiRxTimeOutCntr == 0
case of FSI_run_TRxData function in multi_axis_slave_comms.c file  
```
    FSI_disableRxInterrupt(obj->fsiRxHandle, FSI_INT1, FSI_RX_EVT_PING_FRAME);

    // Assert reset FSI Rx in case of timeout
    FSI_resetRxModule(obj->fsiRxHandle, FSI_RX_MASTER_CORE_RESET);

    DEVICE_DELAY_US(10);

    // De-assert reset FSI Rx in case of timeout
    FSI_clearRxModuleReset(obj->fsiRxHandle, FSI_RX_MASTER_CORE_RESET);

    Interrupt_clearACKGroup(INTERRUPT_ACK_GROUP7);
```
* Change slave node build level for torque control on slave, receive the reference speed/position from master over FSI 
    change BUILDLEVEL from FCL_LEVEL7 to FCL_LEVEL8, 
line 136 in file %MC_SDK%/solutions/tidm_02006_multi_axis_drive/f28004x/include/motor_drive_settings.h

The five source files that contain these four changes are included in the same
folder as this README file. Copy them on top of the same files in the C2000
slave node project.
